#!/usr/bin/clisp -ansi -q -E utf-8
;;;; -*- mode:lisp; coding:utf-8 -*-

(in-package "COMMON-LISP-USER")
(load (make-pathname :name "SCRIPT" :type "LISP" :version NIL :case :common :defaults *load-pathname*))
(script:relauch-with-kfull-linkset-if-needed (lambda () (require "linux")))

(without-output                      
  (load (make-pathname :name ".clisprc" :type "lisp"
                       :defaults (user-homedir-pathname))))

(without-output
  (package:load-package "COM.INFORMATIMAGO.COMMON-LISP.UTILITY")
  (shadow '(handling-errors ed))
  (use-package          "COM.INFORMATIMAGO.COMMON-LISP.UTILITY"))


(defvar *local-intergruas.com* #P"/srv/www/com.intergruas/htdocs/")

(defvar *remote-host*     "intergruas.co.in")
(defvar *remote-user*     "intergru")
(defvar *remote-password* "nUnVNcgU")


(defparameter *expect* nil)

(defun open-expect ()
  (setf *expect*
        (ext:run-program "expect"
                         :arguments '("-c" "interpreter")
                         :input :stream
                         :output :stream))
  (sleep 1)
  (eat))

(defun close-expect () (close *expect*))

(defun eat ()
  (loop :while (listen *expect*) :do (write-char (read-char *expect*))))

(defun send (ctrl-string &rest arguments)
  (eat)
  (prog1 (write-line (format nil "~?" ctrl-string arguments) *expect*)
    (eat)))

(progn
  (open-expect)
  (send "spawn sftp ~A@~A~%" *remote-user* *remote-host*) 
  (send "expect \"password:\"")
  (send "send \"~A\\r\"" *remote-password*)
  (send "expect \"sftp>\"")
  (send "send \"dir\\r\""))


expect "> "
send "amaint\r"
expect "# "
log_user 1
send "[lrange $argv 1 $argc]\r"
expect "# "
log_user 0
send "exit\r"
expect "> "
send "exit\r"
puts "\n"
log_user 1


(loop
  :for line = (read-line in nil nil)
  :until (COM.INFORMATIMAGO.COMMON-LISP.STRING:SUFFIXP "password: " line))
(princ *remote-password* out) (terpri out)
(defparameter *io*   io)
(defparameter *in*   in)
(defparameter *out* out)


(directory (merge-pathnames #P"**/*.*"  *local-intergruas.com* nil))

(finish-output)


;;;; THE END ;;;;
